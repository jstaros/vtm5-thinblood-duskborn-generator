<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VTM5 Thin-blood (Duskborn) Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Fonts & minimal styling -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap">
  <style>
    :root{
      --bg:#0f1115;--panel:#161a22;--ink:#e8ecf1;--muted:#9aa3b2;--accent:#b51e23;--soft:#232a36;--ring:#2e3747;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    a{color:#9dd0ff}
    .wrap{max-width:1200px;margin:40px auto;padding:0 20px}
    .grid{display:grid;gap:16px}
    .g-2{grid-template-columns:1fr 1fr}
    .g-3{grid-template-columns:repeat(3,1fr)}
    @media (max-width:1000px){.g-2,.g-3{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,var(--panel),#12151c);border:1px solid var(--ring);border-radius:16px;padding:16px;box-shadow:0 8px 30px #00000055}
    .h{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    h1{font-weight:800;letter-spacing:.3px;margin:0 0 6px;font-size:28px}
    h2{font-weight:700;font-size:18px;margin:0}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted)}
    input[type="text"],input[type="number"],select,textarea{
      width:100%;background:var(--soft);color:var(--ink);border:1px solid var(--ring);
      border-radius:10px;padding:10px 12px;outline:none
    }
    textarea{min-height:72px;resize:vertical}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#1c2230;border:1px solid var(--ring);border-radius:999px;padding:8px 12px}
    .btn{background:var(--accent);border:none;color:white;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#2b3446}
    .btn.ghost{background:transparent;border:1px solid var(--ring);color:var(--ink)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .section-title{font-weight:800;margin:8px 0 4px}
    .dot-row{display:flex;gap:6px;align-items:center}
    .dot{width:28px;height:28px;border-radius:8px;background:#1b212d;border:1px solid var(--ring);display:flex;align-items:center;justify-content:center;cursor:pointer}
    .dot.active{background:#2a3448}
    .kpi{display:flex;gap:16px;flex-wrap:wrap}
    .kpi .item{background:#1b212d;border:1px solid var(--ring);border-radius:12px;padding:8px 12px}
    .hr{height:1px;background:linear-gradient(90deg,transparent,var(--ring),transparent);margin:12px 0}
    .badge{background:#263146;border:1px solid var(--ring);padding:4px 8px;border-radius:8px;font-size:11px}
    .notice{border-left:3px solid var(--accent);padding:10px 12px;background:#161b24;border-radius:10px}
    .table{width:100%;border-collapse:collapse}
    .table td,.table th{border-bottom:1px solid var(--ring);padding:8px;text-align:left}
    .right{text-align:right}
    .small{font-size:12px}
    .success{color:#77e28c}
    .warn{color:#ffcc66}
    .danger{color:#ff7a7a}
  </style>

  <!-- jsPDF (for fillable PDF), AutoTable (for skills), and AcroForm plugin -->
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/jspdf-forms@1.2.5/dist/jspdf-forms.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="h">
      <div>
        <h1>Thin-blood / Duskborn Character Builder (V5)</h1>
        <div class="muted">Create, roll dice, and export a fillable PDF. Built for Vampire: The Masquerade 5e Thin-bloods.</div>
      </div>
      <div class="row">
        <button id="btnExport" class="btn">Download Fillable PDF</button>
        <button id="btnSaveLocal" class="btn secondary">Save JSON</button>
        <button id="btnLoadLocal" class="btn ghost">Load JSON</button>
      </div>
    </div>

    <div class="grid g-2">
      <!-- Identity -->
      <section class="card">
        <div class="h"><h2>Identity</h2><span class="badge">Basics</span></div>
        <div class="grid g-2">
          <div>
            <label>Character Name</label>
            <input id="name" type="text" placeholder="e.g., Wren ‘Sunset’ Park" />
          </div>
          <div>
            <label>Concept / Archetype</label>
            <select id="archetype">
              <option value="">Choose…</option>
              <option>Blood Chemist</option>
              <option>Caretaker</option>
              <option>Paranormalist</option>
              <option>Street Rat</option>
              <option>Sun Seeker</option>
            </select>
          </div>
          <div>
            <label>Ambition</label>
            <input id="ambition" type="text" placeholder="Long-term goal" />
          </div>
          <div>
            <label>Desire</label>
            <input id="desire" type="text" placeholder="Immediate urge" />
          </div>
          <div>
            <label>Chronicle</label>
            <input id="chronicle" type="text" placeholder="City / Theme" />
          </div>
          <div>
            <label>Coterie</label>
            <input id="coterie" type="text" placeholder="Allies / Role" />
          </div>
          <div>
            <label>Predator Type (optional)</label>
            <input id="predator" type="text" placeholder="Alleycat, Siren, etc." />
          </div>
          <div>
            <label>Convictions (comma-separated)</label>
            <input id="convictions" type="text" placeholder="Never harm children, Protect street artists…" />
          </div>
          <div>
            <label>Touchstones (comma-separated)</label>
            <input id="touchstones" type="text" placeholder="My brother Jay; the soup-kitchen crew…" />
          </div>
          <div>
            <label>Notes</label>
            <input id="notes" type="text" placeholder="Any quick notes" />
          </div>
        </div>
        <div class="hr"></div>
        <div class="notice small">
          Thin-bloods walk the line between mortal and Kindred and often explore Thin-Blood Alchemy as their “edge.” :contentReference[oaicite:1]{index=1}
        </div>
      </section>

      <!-- Merits & Flaws -->
      <section class="card">
        <div class="h"><h2>Thin-blood Merits & Flaws</h2><span class="badge">From V5 Player’s Guide</span></div>
        <div class="grid g-2">
          <div>
            <label>Merits (choose any that fit)</label>
            <select id="merits" multiple size="8">
              <option>Abhorrent Blood</option>
              <option>Faith-proof</option>
              <option>Low Appetite</option>
              <option>Lucid Dreamer</option>
              <option>Mortality’s Mien</option>
              <option>Swift Feeder</option>
            </select>
          </div>
          <div>
            <label>Flaws (choose any that fit)</label>
            <select id="flaws" multiple size="8">
              <option>Heliophobia</option>
              <option>Night Terrors</option>
              <option>Plague Bearer</option>
              <option>Sloppy Drinker</option>
              <option>Sun-Faded</option>
              <option>Supernatural Tell</option>
              <option>Twilight Presence</option>
              <option>Unending Hunger</option>
            </select>
          </div>
        </div>
        <div class="small muted" style="margin-top:8px">
          These Thin-blood-only Merits/Flaws are presented as paired trade-offs in the Player’s Guide (no dot costs). :contentReference[oaicite:2]{index=2}
        </div>
      </section>
    </div>

    <!-- Attributes -->
    <section class="card">
      <div class="h"><h2>Attributes</h2><span class="badge">Point-buy with presets</span></div>
      <div class="kpi">
        <div class="item small">Primary Budget: <span id="attrPrimaryBudget">6</span></div>
        <div class="item small">Secondary Budget: <span id="attrSecondaryBudget">4</span></div>
        <div class="item small">Tertiary Budget: <span id="attrTertiaryBudget">3</span></div>
        <div class="item small">Minimum 1 dot each; max 5.</div>
        <div class="item"><button id="btnAutoAttrs" class="btn secondary">Auto-assign (balanced)</button></div>
      </div>
      <div class="grid g-3" id="attrGrid"></div>
    </section>

    <!-- Skills -->
    <section class="card">
      <div class="h"><h2>Skills</h2><span class="badge">Point-buy with presets</span></div>
      <div class="kpi">
        <div class="item small">Primary: <span id="skillPrimaryBudget">11</span></div>
        <div class="item small">Secondary: <span id="skillSecondaryBudget">7</span></div>
        <div class="item small">Tertiary: <span id="skillTertiaryBudget">4</span></div>
        <div class="item small">Min 0; max 5. Add specs in notes.</div>
        <div class="item"><button id="btnAutoSkills" class="btn secondary">Auto-assign (career-ish)</button></div>
      </div>
      <div class="grid g-3" id="skillGrid"></div>
    </section>

    <!-- Thin-Blood bits -->
    <section class="card">
      <div class="h"><h2>Thin-blood Stuff</h2><span class="badge">V5 Duskborn</span></div>
      <div class="grid g-3">
        <div>
          <label>Hunger (0–5)</label>
          <input id="hunger" type="number" min="0" max="5" value="1" />
        </div>
        <div>
          <label>Health (Derived)</label>
          <input id="health" type="number" min="1" max="15" value="7" />
        </div>
        <div>
          <label>Willpower (Derived)</label>
          <input id="willpower" type="number" min="1" max="10" value="5" />
        </div>
        <div>
          <label>Thin-Blood Alchemy Notes</label>
          <textarea id="alchemy" placeholder="Formulae, Ingredients, Lab access …"></textarea>
        </div>
        <div>
          <label>Advantages (Contacts, Allies, Resources, etc.)</label>
          <textarea id="advantages"></textarea>
        </div>
        <div>
          <label>Flaws / Banes</label>
          <textarea id="banes"></textarea>
        </div>
      </div>
      <div class="hr"></div>
      <div class="notice small">
        Optional rule reminders: some Thin-bloods struggle with sunlight, social friction with Kindred, or unusual feeding quirks—use Merits/Flaws above to reflect these. :contentReference[oaicite:3]{index=3}
      </div>
    </section>

    <!-- Dice Roller -->
    <section class="card">
      <div class="h"><h2>Dice Roller</h2><span class="badge">V5 successes, Hunger, crits</span></div>
      <div class="row">
        <div class="pill"><label>Dice Pool</label><input id="pool" type="number" min="0" value="6" style="width:80px"></div>
        <div class="pill"><label>Hunger</label><input id="poolHunger" type="number" min="0" max="5" value="2" style="width:80px"></div>
        <button id="btnRoll" class="btn">Roll</button>
      </div>
      <div id="rollOutput" class="small" style="margin-top:10px"></div>
    </section>

    <!-- Settings -->
    <section class="card">
      <div class="h"><h2>Settings</h2><span class="badge">Budgets & options</span></div>
      <div class="grid g-3">
        <div>
          <label>Attribute Budgets (Primary/Secondary/Tertiary)</label>
          <div class="row">
            <input id="sAttrP" type="number" min="0" value="6" style="width:90px">
            <input id="sAttrS" type="number" min="0" value="4" style="width:90px">
            <input id="sAttrT" type="number" min="0" value="3" style="width:90px">
          </div>
        </div>
        <div>
          <label>Skill Budgets (Primary/Secondary/Tertiary)</label>
          <div class="row">
            <input id="sSkillP" type="number" min="0" value="11" style="width:90px">
            <input id="sSkillS" type="number" min="0" value="7" style="width:90px">
            <input id="sSkillT" type="number" min="0" value="4" style="width:90px">
          </div>
        </div>
        <div>
          <label>Auto-assign Lean</label>
          <select id="autoLean">
            <option value="balanced">Balanced</option>
            <option value="physical">Physical-leaning</option>
            <option value="social">Social-leaning</option>
            <option value="mental">Mental-leaning</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnApply" class="btn secondary">Apply Budgets</button>
        <div class="muted small">You can override any dots manually afterward.</div>
      </div>
    </section>

    <footer class="muted small" style="margin-top:24px">
      Thin-blood/Duskborn context & Merits/Flaws adapted from the Vampire: The Masquerade Player’s Guide (2023). For table play, always defer to your ST’s rulings. :contentReference[oaicite:4]{index=4}
    </footer>
  </div>

  <script>
    // ======= Data =======
    const ATTR_GROUPS = {
      Physical: ["Strength","Dexterity","Stamina"],
      Social: ["Charisma","Manipulation","Composure"],
      Mental: ["Intelligence","Wits","Resolve"]
    };

    const SKILLS = {
      Physical:["Athletics","Brawl","Craft","Drive","Firearms","Larceny","Melee","Stealth","Survival"],
      Social:["Animal Ken","Etiquette","Insight","Intimidation","Leadership","Performance","Persuasion","Streetwise","Subterfuge"],
      Mental:["Academics","Awareness","Finance","Investigation","Medicine","Occult","Politics","Science","Technology"]
    };

    // ======= Helpers =======
    const $ = sel => document.querySelector(sel);
    const el = (tag,cls) => { const n=document.createElement(tag); if(cls) n.className=cls; return n; };

    function makeDotRow(idPrefix, start=1, min=1, max=5, onChange){
      const row = el('div','dot-row');
      const val = el('input'); val.type='hidden'; val.value = start; val.dataset.min=min; val.dataset.max=max;
      for(let i=1;i<=5;i++){
        const d = el('div','dot'); d.textContent=i;
        if(i<=start) d.classList.add('active');
        d.addEventListener('click',()=>{
          const v = i;
          val.value=v;
          for(const child of row.querySelectorAll('.dot')){
            child.classList.toggle('active', parseInt(child.textContent)<=v);
          }
          onChange?.(v);
        });
        row.appendChild(d);
      }
      row.appendChild(val);
      return {row,value:val};
    }

    // ======= Build Attribute UI =======
    const attrGrid = $("#attrGrid");
    const attrState = {};
    function buildAttrs(){
      attrGrid.innerHTML='';
      Object.entries(ATTR_GROUPS).forEach(([group, attrs])=>{
        const card = el('div','card');
        const h = el('div','h'); h.innerHTML = `<h2>${group}</h2><span class="badge">min 1 • max 5</span>`; card.appendChild(h);
        attrs.forEach(name=>{
          const wrap = el('div');
          wrap.innerHTML = `<div class="section-title">${name}</div>`;
          const dots = makeDotRow(`attr-${name}`, 1, 1, 5, v => attrState[name]=v);
          attrState[name]=1;
          wrap.appendChild(dots.row);
          card.appendChild(wrap);
        });
        attrGrid.appendChild(card);
      });
    }

    // ======= Build Skill UI =======
    const skillGrid = $("#skillGrid");
    const skillState = {};
    function buildSkills(){
      skillGrid.innerHTML='';
      Object.entries(SKILLS).forEach(([group, skills])=>{
        const card = el('div','card');
        const h = el('div','h'); h.innerHTML = `<h2>${group}</h2><span class="badge">0–5</span>`; card.appendChild(h);
        skills.forEach(name=>{
          const wrap = el('div');
          wrap.innerHTML = `<div class="section-title">${name}</div>`;
          const dots = makeDotRow(`skill-${name}`, 0, 0, 5, v => skillState[name]=v);
          // set to 0 by de-activating all initially
          for(const d of dots.row.querySelectorAll('.dot')) d.classList.remove('active');
          skillState[name]=0;
          wrap.appendChild(dots.row);
          card.appendChild(wrap);
        });
        skillGrid.appendChild(card);
      });
    }

    buildAttrs(); buildSkills();

    // ======= Budgets & Auto-assign =======
    function getBudgets(){
      return {
        attr: {
          primary: parseInt($("#sAttrP").value||6),
          secondary: parseInt($("#sAttrS").value||4),
          tertiary: parseInt($("#sAttrT").value||3)
        },
        skills: {
          primary: parseInt($("#sSkillP").value||11),
          secondary: parseInt($("#sSkillS").value||7),
          tertiary: parseInt($("#sSkillT").value||4)
        }
      };
    }

    function applyBudgets(){
      const b = getBudgets();
      $("#attrPrimaryBudget").textContent = b.attr.primary;
      $("#attrSecondaryBudget").textContent = b.attr.secondary;
      $("#attrTertiaryBudget").textContent = b.attr.tertiary;
      $("#skillPrimaryBudget").textContent = b.skills.primary;
      $("#skillSecondaryBudget").textContent = b.skills.secondary;
      $("#skillTertiaryBudget").textContent = b.skills.tertiary;
    }
    $("#btnApply").addEventListener('click',applyBudgets);
    applyBudgets();

    function autoAssignAttributes(){
      const lean = $("#autoLean").value;
      const b = getBudgets().attr;
      // reset to 1 each
      Object.keys(attrState).forEach(k=>attrState[k]=1);
      const groups = {
        physical: ["Strength","Dexterity","Stamina"],
        social: ["Charisma","Manipulation","Composure"],
        mental: ["Intelligence","Wits","Resolve"]
      };
      const order = (()=>{
        switch(lean){
          case 'physical': return ["physical","social","mental"];
          case 'social': return ["social","mental","physical"];
          case 'mental': return ["mental","social","physical"];
          default: return ["physical","social","mental"];
        }
      })();
      const budgets = [b.primary,b.secondary,b.tertiary];
      // add dots evenly until budgets spent (above the base 1 each)
      order.forEach((group,idx)=>{
        let pool = budgets[idx];
        const names = groups[group];
        while(pool>0){
          names.sort((a,b)=>attrState[a]-attrState[b]); // raise the lowest first
          const target = names[0];
          if(attrState[target]<5){ attrState[target]++; pool--; } else {
            names.shift();
            if(!names.length) break;
          }
        }
      });
      // re-paint
      repaintDots(attrState, 'attr');
    }
    $("#btnAutoAttrs").addEventListener('click', autoAssignAttributes);

    function autoAssignSkills(){
      const b = getBudgets().skills;
      // zero all first
      Object.keys(skillState).forEach(k=>skillState[k]=0);
      const groups = {
        primary: Object.keys(SKILLS)[0],
        secondary: Object.keys(SKILLS)[1],
        tertiary: Object.keys(SKILLS)[2]
      };
      // helper: spread points across a list up to max 5 with diminishing returns
      function spread(names,total){
        let i=0;
        while(total>0){
          const name = names[i%names.length];
          if(skillState[name]<5){ skillState[name]++; total--; }
          i++;
        }
      }
      const all = { Physical: SKILLS.Physical.slice(), Social: SKILLS.Social.slice(), Mental: SKILLS.Mental.slice() };
      // Use a simple heuristic: primary = Mental if archetype is Blood Chemist or Paranormalist, else Physical
      const arch = $("#archetype").value;
      let primaryGroup = (arch==="Blood Chemist"||arch==="Paranormalist") ? "Mental" : "Physical";
      let secondaryGroup = "Social", tertiaryGroup = (primaryGroup==="Physical"?"Mental":"Physical");
      spread(all[primaryGroup], b.primary);
      spread(all[secondaryGroup], b.secondary);
      spread(all[tertiaryGroup], b.tertiary);
      repaintDots(skillState, 'skill');
    }
    $("#btnAutoSkills").addEventListener('click', autoAssignSkills);

    function repaintDots(state, prefix){
      for(const [name,val] of Object.entries(state)){
        const container = document.querySelectorAll(`[id^=${prefix}-${CSS.escape(name)}]`);
        // not strictly needed due to single build, but kept for clarity
      }
      // brute force: repaint all dot groups
      document.querySelectorAll('.dot-row').forEach(row=>{
        const dots = [...row.querySelectorAll('.dot')];
        const v = parseInt(row.querySelector('input[type=hidden]')?.value || 0);
        dots.forEach(d=>d.classList.toggle('active', parseInt(d.textContent)<=v));
      });
    }

    // ======= Dice Roller (V5) =======
    function rollV5(pool, hunger){
      const results = { normals:[], hungers:[], successes:0, crits:0, messy:false, bestial:false };
      function d10(){ return Math.floor(Math.random()*10)+1; }
      for(let i=0;i<Math.max(pool-hunger,0);i++){ results.normals.push(d10()); }
      for(let i=0;i<Math.min(hunger,pool);i++){ results.hungers.push(d10()); }
      const all = [...results.normals, ...results.hungers];
      // count successes (6–9 = 1, 10s handled below)
      results.successes = all.filter(n=>n>=6 && n<10).length;
      const tens = all.filter(n=>n===10).length;
      results.crits = Math.floor(tens/2); // each pair = +2 extra successes
      results.successes += results.crits*2 + tens; // each 10 counts as 1 + pair bonus
      const hungerTens = results.hungers.filter(n=>n===10).length;
      const anySuccess = results.successes>0;
      const anyHungerOne = results.hungers.includes(1);
      if(hungerTens>0 && tens>=2) results.messy = true;
      if(anyHungerOne && !anySuccess) results.bestial = true;
      return results;
    }

    $("#btnRoll").addEventListener('click',()=>{
      const pool = parseInt($("#pool").value||0);
      const hunger = Math.min(Math.max(parseInt($("#poolHunger").value||0),0),5);
      const r = rollV5(pool,hunger);
      const fmt = arr => arr.map(n=>{
        if(n===10) return `<b class="success">10★</b>`;
        if(n>=6) return `<b class="success">${n}</b>`;
        if(n===1) return `<span class="danger">1</span>`;
        return `<span class="muted">${n}</span>`;
      }).join(' ');
      $("#rollOutput").innerHTML = `
        <div class="row">
          <div class="item small">Normals: ${fmt(r.normals)}</div>
          <div class="item small">Hunger: ${fmt(r.hungers)}</div>
        </div>
        <div class="kpi" style="margin-top:8px">
          <div class="item">Total Successes: <b>${r.successes}</b></div>
          <div class="item">Crit Pairs: <b>${r.crits}</b> ${r.messy?'<span class="warn">(Messy)</span>':''}</div>
          ${r.bestial?'<div class="item danger">Bestial Failure!</div>':''}
        </div>
      `;
    });

    // ======= Save / Load JSON =======
    function collectData(){
      return {
        name: $("#name").value, archetype: $("#archetype").value, ambition: $("#ambition").value, desire: $("#desire").value,
        chronicle: $("#chronicle").value, coterie: $("#coterie").value, predator: $("#predator").value,
        convictions: $("#convictions").value, touchstones: $("#touchstones").value, notes: $("#notes").value,
        merits: [...$("#merits").selectedOptions].map(o=>o.value),
        flaws: [...$("#flaws").selectedOptions].map(o=>o.value),
        attrs: {...attrState},
        skills: {...skillState},
        hunger: parseInt($("#hunger").value||0),
        health: parseInt($("#health").value||0),
        willpower: parseInt($("#willpower").value||0),
        alchemy: $("#alchemy").value,
        advantages: $("#advantages").value,
        banes: $("#banes").value,
        settings: getBudgets()
      };
    }
    function loadData(data){
      $("#name").value=data.name||'';
      $("#archetype").value=data.archetype||'';
      $("#ambition").value=data.ambition||'';
      $("#desire").value=data.desire||'';
      $("#chronicle").value=data.chronicle||'';
      $("#coterie").value=data.coterie||'';
      $("#predator").value=data.predator||'';
      $("#convictions").value=data.convictions||'';
      $("#touchstones").value=data.touchstones||'';
      $("#notes").value=data.notes||'';
      // merits/flaws
      [...$("#merits").options].forEach(o=>o.selected = data.merits?.includes(o.value));
      [...$("#flaws").options].forEach(o=>o.selected = data.flaws?.includes(o.value));
      // attributes
      if(data.attrs){ for(const [k,v] of Object.entries(data.attrs)){ attrState[k]=v; } repaintDots(attrState,'attr'); }
      if(data.skills){ for(const [k,v] of Object.entries(data.skills)){ skillState[k]=v; } repaintDots(skillState,'skill'); }
      $("#hunger").value=data.hunger??1;
      $("#health").value=data.health??7;
      $("#willpower").value=data.willpower??5;
      $("#alchemy").value=data.alchemy||'';
      $("#advantages").value=data.advantages||'';
      $("#banes").value=data.banes||'';
      if(data.settings){
        $("#sAttrP").value=data.settings.attr?.primary??6;
        $("#sAttrS").value=data.settings.attr?.secondary??4;
        $("#sAttrT").value=data.settings.attr?.tertiary??3;
        $("#sSkillP").value=data.settings.skills?.primary??11;
        $("#sSkillS").value=data.settings.skills?.secondary??7;
        $("#sSkillT").value=data.settings.skills?.tertiary??4;
        applyBudgets();
      }
    }

    $("#btnSaveLocal").addEventListener('click',()=>{
      const data = collectData();
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (data.name?.trim() || 'thinblood') + '_vtm5.json';
      document.body.appendChild(a); a.click(); a.remove();
    });

    $("#btnLoadLocal").addEventListener('click',()=>{
      const i = document.createElement('input'); i.type='file'; i.accept='application/json';
      i.addEventListener('change', async ()=>{
        const file = i.files[0]; if(!file) return;
        const text = await file.text();
        try{ const data = JSON.parse(text); loadData(data); } catch(e){ alert('Invalid JSON.'); }
      });
      i.click();
    });

    // ======= PDF (fillable) =======
    async function exportPDF(){
      const data = collectData();
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'letter' });
      const margin = 36;
      const line = (y)=>{ doc.setDrawColor(60,70,90); doc.line(margin,y,612-margin,y); }
      doc.setFont('helvetica','bold'); doc.setFontSize(16);
      doc.text('VTM5 Thin-blood / Duskborn Character Sheet', margin, 50);
      doc.setFontSize(10); doc.setFont('helvetica','normal');
      doc.text('Generated in-browser • PDF is fillable', margin, 66);
      line(74);

      const f = window.jsPDFAcroForm; // from jspdf-forms
      f.initForm(doc);

      let y = 92;
      function field(label, val, x, w){
        doc.setFont('helvetica','bold'); doc.text(label, x, y); doc.setFont('helvetica','normal');
        f.TextField({name:label, x:x, y:y+6, width:w, height:16, value: String(val||'')});
      }

      // Row 1
      field('Name', data.name, margin, 200);
      field('Archetype', data.archetype, margin+210, 140);
      field('Chronicle', data.chronicle, margin+360, 200);
      y += 34;
      field('Ambition', data.ambition, margin, 300);
      field('Desire', data.desire, margin+310, 250);
      y += 34;
      field('Coterie', data.coterie, margin, 200);
      field('Predator Type', data.predator, margin+210, 160);
      field('Hunger', data.hunger, margin+380, 50);
      field('Health', data.health, margin+442, 50);
      field('Willpower', data.willpower, margin+504, 68);
      y += 40; line(y); y+=16;

      // Attributes block
      doc.setFont('helvetica','bold'); doc.setFontSize(12);
      doc.text('Attributes', margin, y); doc.setFontSize(10); doc.setFont('helvetica','normal');
      const attrCols = [["Physical","Strength","Dexterity","Stamina"],["Social","Charisma","Manipulation","Composure"],["Mental","Intelligence","Wits","Resolve"]];
      let ax = margin, ay = y+10;
      attrCols.forEach(col=>{
        doc.text(col[0], ax, ay);
        let yy=ay+8;
        for(let i=1;i<col.length;i++){
          const name = col[i];
          doc.text(name, ax, yy+10);
          f.TextField({name:`Attr.${name}`, x:ax+90, y:yy+2, width:30, height:16, value:String(data.attrs[name]||1)});
          yy += 22;
        }
        ax += 190;
      });
      y = y + 110; line(y); y+=16;

      // Skills table
      doc.setFont('helvetica','bold'); doc.setFontSize(12);
      doc.text('Skills', margin, y);
      doc.autoTable({
        startY: y+6,
        theme: 'plain',
        headStyles: { fillColor:[0,0,0] },
        styles: { cellPadding: 3, fontSize: 9 },
        head:[['Skill','Dots','Skill','Dots','Skill','Dots']],
        body: (function(){
          const rows=[];
          const maxRows = Math.max(SKILLS.Physical.length, SKILLS.Social.length, SKILLS.Mental.length);
          for(let i=0;i<maxRows;i++){
            const p = SKILLS.Physical[i], s = SKILLS.Social[i], m = SKILLS.Mental[i];
            rows.push([
              p||'', String(p? (data.skills[p]||0):''), 
              s||'', String(s? (data.skills[s]||0):''), 
              m||'', String(m? (data.skills[m]||0):'')
            ]);
          }
          return rows;
        })()
      });
      y = doc.lastAutoTable.finalY + 10; line(y); y+=16;

      // Merits / Flaws
      doc.setFont('helvetica','bold'); doc.setFontSize(12);
      doc.text('Merits & Flaws (Thin-blood)', margin, y); doc.setFontSize(10); doc.setFont('helvetica','normal');
      f.TextField({name:'Merits', x:margin, y:y+6, width:260, height:40, value:(data.merits||[]).join(', ')});
      f.TextField({name:'Flaws', x:margin+270, y:y+6, width:260, height:40, value:(data.flaws||[]).join(', ')});
      y += 56; line(y); y+=16;

      // Alchemy & Advantages / Notes
      doc.setFont('helvetica','bold'); doc.text('Thin-Blood Alchemy', margin, y); doc.setFont('helvetica','normal');
      f.TextField({name:'Alchemy', x:margin, y:y+6, width:530, height:50, value:data.alchemy||'' , multiline:true});
      y += 64;
      doc.setFont('helvetica','bold'); doc.text('Advantages', margin, y); doc.setFont('helvetica','normal');
      f.TextField({name:'Advantages', x:margin, y:y+6, width:530, height:50, value:data.advantages||'' , multiline:true});
      y += 64;
      doc.setFont('helvetica','bold'); doc.text('Flaws / Banes / Notes', margin, y); doc.setFont('helvetica','normal');
      f.TextField({name:'Banes', x:margin, y:y+6, width:530, height:60, value:data.banes||'' , multiline:true});
      y += 80; line(y);

      f.finalizeForm();

      doc.save((data.name?.trim() || 'thinblood') + '_vtm5_fillable.pdf');
    }
    $("#btnExport").addEventListener('click', exportPDF);

  </script>
</body>
</html>
